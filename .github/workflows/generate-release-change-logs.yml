name: Draft Release and Push to Backlog

on:
  pull-request:
    types: [ready_to_review]

jobs:
  post-release-to-backlog:
    if: |
      github.event.pull_request.draft == true &&
      startsWith(github.event.pull_request.head.ref, 'release/') &&
      github.event.pull_request.base.ref == 'master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get release info
        id: release_info
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: context.payload.release.tag_name
            });
            return release.data.body;

      - name: Post changelog to Backlog.com
        env:
          BACKLOG_SPACE: swiftclock.backlog.com
          BACKLOG_API_KEY: ${{ secrets.BACKLOG_API_KEY }}
          BACKLOG_PROJECT_KEY: RELEASE
        run: |
          echo "Posting changelog to Backlog..."

          body=$(echo "${{ steps.release_info.outputs.result }}" | jq -Rs .)
          curl -X POST "https://${BACKLOG_SPACE}.backlog.com/api/v2/issues?apiKey=${BACKLOG_API_KEY}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "projectIdOrKey=${BACKLOG_PROJECT_KEY}" \
            --data-urlencode "summary=Release ${{ github.event.release.tag_name }}" \
            --data-urlencode "description=${body}" \
            --data-urlencode "issueTypeId=1" \
            --data-urlencode "priorityId=3"
