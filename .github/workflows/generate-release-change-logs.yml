name: Draft Release and Push to Backlog

on:
  pull_request:
    types: [ready_for_review, synchronize]
    
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  post-release-to-backlog:
    if: |
      github.event.pull_request.draft == false &&
      startsWith(github.event.pull_request.head.ref, 'release/') &&
      github.event.pull_request.base.ref == 'master'
    runs-on: ubuntu-latest
    environment:
      name: prd

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get PR body as release notes
        id: release_info
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || 'No changelog provided.';
            return body;

      - name: Post changelog to Backlog.com
        env:
          BACKLOG_SPACE: swiftclock.backlog.com
          BACKLOG_API_KEY: ${{ secrets.BACKLOG_API_KEY }}
          BACKLOG_PROJECT_ID: 151481
        run: |
          echo "Posting changelog to Backlog..."

          body=$(echo "${{ steps.release_info.outputs.result }}" | jq -Rs .)
          curl -X POST "https://${BACKLOG_SPACE}/api/v2/issues?apiKey=${BACKLOG_API_KEY}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "projectIdOrKey=${BACKLOG_PROJECT_ID}" \
            --data-urlencode "summary=Release from PR #${{ github.event.pull_request.number }}" \
            --data-urlencode "description=${body}" \
            --data-urlencode "issueTypeId=1" \
            --data-urlencode "priorityId=3"

      - name: Comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âœ… Changelog has been posted to Backlog for PR #${context.issue.number}."
            });
